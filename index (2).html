<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PIN Kod Tizimi — 24 soatlik</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #06b6d4;
      --ok: #22c55e;
      --err: #ef4444;
      --muted: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(135deg, var(--bg), #111827 50%, #0b1022);
      color: #e5e7eb;
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .wrap {
      width: 100%;
      max-width: 460px;
      background: rgba(17, 24, 39, 0.85);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 18px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
      padding: 28px;
      backdrop-filter: blur(6px);
    }
    h1 {
      font-size: 22px;
      margin: 0 0 10px;
      letter-spacing: 0.3px;
    }
    .sub {
      margin: 0 0 18px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.4;
    }
    .inputgroup {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      margin-top: 10px;
    }
    input[type="text"] {
      width: 100%;
      padding: 14px 16px;
      background: #0b1220;
      border: 1px solid #233147;
      border-radius: 12px;
      color: #e5e7eb;
      font-size: 18px;
      letter-spacing: 2px;
      text-align: center;
      outline: none;
      transition: border-color .2s ease;
    }
    input[type="text"]:focus {
      border-color: var(--accent);
    }
    button {
      padding: 12px 16px;
      border: 0;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: transform .06s ease, opacity .2s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #22d3ee);
      color: #0b1022;
    }
    .btn-primary:active { transform: translateY(1px); }
    .mute { font-size: 12px; color: var(--muted); margin-top: 8px; }
    .msg { margin-top: 14px; font-weight: 600; }
    .msg.ok { color: var(--ok); }
    .msg.err { color: var(--err); }
    .meta { margin-top: 12px; font-size: 13px; color: var(--muted); }
    .footer {
      margin-top: 18px; font-size: 12px; color: #94a3b8;
      border-top: 1px dashed #233147; padding-top: 12px;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>PIN-kodni kiriting</h1>
    <p class="sub">Har bir parol <strong>faqat 24 soat</strong> amal qiladi. To‘g‘ri parol kiritilgach, avtomatik ravishda sahifaga yo‘naltirilasiz.</p>

    <div class="inputgroup">
      <input id="pinInput" type="text" inputmode="numeric" placeholder="Masalan: 123456" maxlength="12" autocomplete="one-time-code" />
      <button id="checkBtn" class="btn-primary">Tasdiqlash</button>
    </div>
    <div class="mute">Maslahat: PIN 6 ta raqamdan iborat.</div>

    <div id="message" class="msg hidden"></div>
    <div id="meta" class="meta hidden"></div>

    <div class="footer">© 2025 PIN tizimi • 24 soatlik parollar</div>
  </main>

  <script>
    const elInput = document.getElementById("pinInput");
    const elBtn = document.getElementById("checkBtn");
    const elMsg = document.getElementById("message");
    const elMeta = document.getElementById("meta");

    // Local (mijoz tomoni) bo'yicha ishlatilgan PINlar
    const usedKey = "usedPins";
    const usedPins = (() => {
      try { return JSON.parse(localStorage.getItem(usedKey)) || []; }
      catch (e) { return []; }
    })();

    function setMsg(text, ok=false) {
      elMsg.textContent = text;
      elMsg.classList.remove("hidden", "ok", "err");
      elMsg.classList.add(ok ? "ok" : "err");
    }

    function setMeta(text) {
      elMeta.textContent = text;
      elMeta.classList.remove("hidden");
    }

    async function getPins() {
      // keshdan qochish
      const res = await fetch("pins.json?ts=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("pins.json yuklab bo'lmadi");
      return res.json();
    }

    function alreadyUsed(pin) {
      return usedPins.includes(pin);
    }

    function markUsed(pin) {
      try {
        const list = new Set(usedPins);
        list.add(pin);
        localStorage.setItem(usedKey, JSON.stringify(Array.from(list)));
      } catch (e) {}
    }

    function fmt(dt) {
      try {
        return new Date(dt).toLocaleString(undefined, {
          year: "numeric", month: "2-digit", day: "2-digit",
          hour: "2-digit", minute: "2-digit"
        });
      } catch(e) {
        return dt;
      }
    }

    elBtn.addEventListener("click", async () => {
      const entered = elInput.value.trim();
      elMeta.classList.add("hidden");
      if (!entered) { setMsg("PIN kiritilmadi.", false); return; }

      try {
        const db = await getPins();
        const found = db.find(x => x.pin === entered);
        if (!found) {
          setMsg("Xato! PIN kod noto‘g‘ri.", false);
          return;
        }

        // 1) Amal qilish muddati
        const now = Date.now();
        const exp = Date.parse(found.expiry);
        if (isNaN(exp)) {
          setMsg("Konfiguratsiya xatosi: amal qilish vaqti noto‘g‘ri.", false);
          return;
        }
        if (now > exp) {
          setMsg("Xatolik! PIN muddati tugagan.", false);
          setMeta("Tugash vaqti: " + fmt(found.expiry));
          return;
        }

        // 2) Bir qurilmada faqat bir marta ishlatish
        if (alreadyUsed(entered)) {
          setMsg("Ushbu PIN oldin shu qurilmada ishlatilgan.", false);
          setMeta("Amal qilish vaqti: " + fmt(found.expiry));
          return;
        }

        // OK — yo'naltirish
        markUsed(entered);
        setMsg("PIN to‘g‘ri! Yo‘naltirilmoqda...", true);
        setMeta("Amal qilish vaqti: " + fmt(found.expiry));

        const url = (found.url && typeof found.url === "string") ? found.url : null;
        setTimeout(() => {
          if (url) window.location.href = url;
          else window.location.reload();
        }, 1300);
      } catch (e) {
        setMsg("Server bilan bog‘lanishda xatolik: " + e.message, false);
      }
    });

    // Enter tugmasi bilan tasdiqlash
    elInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") elBtn.click();
    });
  </script>
</body>
</html>
